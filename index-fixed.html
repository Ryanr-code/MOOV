<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <base target="_self">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moov | Location Premium Antony</title>
    <meta name="description" content="Location de véhicules premium à Antony. Réservez et payez en ligne. Processus autonome sécurisé.">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        page: '#050505',
                        card: '#121212',
                        input: '#1E1E1E',
                        border: '#2A2A2A',
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        text: '#FFFFFF',
                        muted: '#A1A1AA'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            color: #FFFFFF;
            font-family: 'Outfit', sans-serif;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #2A2A2A; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563EB; }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .cal-day {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            background: #1E1E1E;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .cal-day:hover:not(.disabled) { border-color: #2563EB; color: #2563EB; }
        .cal-day.disabled { opacity: 0.3; cursor: not-allowed; background: #121212; }
        .cal-day.selected { background: #2563EB; color: white; border-color: #2563EB; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
        .cal-day.in-range { background: rgba(37, 99, 235, 0.2); color: #60A5FA; border-color: transparent; }

        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .category-tab {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .category-tab.active {
            background: #2563EB;
            color: white;
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }
        .category-tab:not(.active) {
            background: #1E1E1E;
            color: #A1A1AA;
        }
        .category-tab:not(.active):hover {
            background: #2A2A2A;
            color: white;
        }

        .faq-item {
            border-bottom: 1px solid #2A2A2A;
            transition: all 0.3s ease;
        }
        .faq-item:last-child {
            border-bottom: none;
        }
        .faq-question {
            cursor: pointer;
            padding: 24px 0;
        }
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .faq-answer.open {
            max-height: 500px;
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased selection:bg-primary selection:text-white">

    <header class="fixed w-full z-50 bg-page/80 backdrop-blur-md border-b border-border">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between">
            <a href="#" onclick="navigateToHome()" class="text-3xl font-bold tracking-tighter cursor-pointer">
                MOOV<span class="text-primary">.</span>
            </a>
            <nav class="hidden md:flex gap-8 text-sm font-medium text-muted">
                <a href="#flotte" onclick="scrollToSection('flotte')" class="hover:text-white transition-colors cursor-pointer">Véhicules</a>
                <a href="#fonctionnement" onclick="scrollToSection('fonctionnement')" class="hover:text-white transition-colors cursor-pointer">Fonctionnement</a>
                <a href="#faq" onclick="scrollToSection('faq')" class="hover:text-white transition-colors cursor-pointer">FAQ</a>
            </nav>
            <button onclick="scrollToSection('flotte')" class="bg-white text-black px-6 py-2.5 rounded-full font-bold text-sm hover:bg-gray-200 transition-colors cursor-pointer">
                Réserver
            </button>
        </div>
    </header>

    <section class="pt-32 pb-20 px-6">
        <div class="container mx-auto text-center max-w-4xl">
            <h1 class="text-5xl md:text-6xl font-bold mb-6 leading-tight">
                Location premium
                <span class="text-primary">sans contrainte</span>
            </h1>
            <p class="text-xl text-muted mb-10 max-w-2xl mx-auto">
                Réservez votre véhicule en ligne, payez en toute sécurité, et profitez d'un processus de retrait et retour autonome à Antony.
            </p>
            <button onclick="scrollToSection('flotte')" class="bg-primary hover:bg-primaryHover text-white px-8 py-4 rounded-full font-bold text-lg transition-all cursor-pointer">
                Découvrir les véhicules
            </button>
        </div>
    </section>

    <section class="py-12 border-y border-border">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                <div>
                    <div class="text-3xl font-bold mb-2">24/7</div>
                    <div class="text-muted text-sm">Assistance</div>
                </div>
                <div>
                    <div class="text-3xl font-bold mb-2">0€</div>
                    <div class="text-muted text-sm">Frais cachés</div>
                </div>
                <div>
                    <div class="text-3xl font-bold mb-2">150km</div>
                    <div class="text-muted text-sm">Inclus/jour</div>
                </div>
                <div>
                    <div class="text-3xl font-bold mb-2">100%</div>
                    <div class="text-muted text-sm">En ligne</div>
                </div>
            </div>
        </div>
    </section>

    <section id="flotte" class="py-16 px-6">
        <div class="container mx-auto">
            <div class="flex justify-center gap-4 mb-12">
                <button id="tab-particuliers" onclick="switchCategory('particuliers')" class="category-tab active">
                    Véhicules particuliers
                </button>
                <button id="tab-utilitaires" onclick="switchCategory('utilitaires')" class="category-tab">
                    Véhicules utilitaires
                </button>
            </div>

            <div id="vehicle-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8"></div>
        </div>
    </section>

    <section id="fonctionnement" class="py-20 px-6 bg-card">
        <div class="container mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Comment ça marche</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center">
                    <div class="w-16 h-16 bg-primary/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-calendar-alt text-primary text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">1. Réservez en ligne</h3>
                    <p class="text-muted">Choisissez votre véhicule, vos dates, et payez en toute sécurité.</p>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-primary/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-map-marker-alt text-primary text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">2. Accès autonome</h3>
                    <p class="text-muted">Recevez l'adresse exacte et accédez au véhicule selon vos horaires.</p>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-primary/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-car text-primary text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">3. Profitez du trajet</h3>
                    <p class="text-muted">150km inclus par jour, assurance tous risques, retour simplifié.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="faq" class="py-20 px-6">
        <div class="container mx-auto max-w-3xl">
            <h2 class="text-3xl font-bold text-center mb-12">Questions fréquentes</h2>
            <div class="space-y-4">
                <div class="faq-item">
                    <div class="faq-question flex justify-between items-center" onclick="toggleFAQ(1)">
                        <h3 class="text-lg font-semibold">Comment fonctionne le check-in et check-out ?</h3>
                        <i class="fas fa-chevron-down text-muted transition-transform duration-300" id="faq-icon-1"></i>
                    </div>
                    <div class="faq-answer" id="faq-answer-1">
                        <div class="pb-6 text-muted">
                            <p>Notre processus est entièrement autonome. Après validation de votre réservation, vous recevez l'adresse exacte et pouvez accéder au véhicule à l'heure convenue sans rencontre physique.</p>
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question flex justify-between items-center" onclick="toggleFAQ(2)">
                        <h3 class="text-lg font-semibold">Quelle est la politique de kilométrage ?</h3>
                        <i class="fas fa-chevron-down text-muted transition-transform duration-300" id="faq-icon-2"></i>
                    </div>
                    <div class="faq-answer" id="faq-answer-2">
                        <div class="pb-6 text-muted">
                            <p>Chaque location inclut 150 km par jour. Les kilomètres supplémentaires sont facturés 0,25€/km pour les véhicules particuliers et 0,30€/km pour les utilitaires.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-12">
                <a href="#" onclick="navigateToFAQ()" class="text-primary hover:text-primaryHover font-bold cursor-pointer">
                    Voir toutes les questions fréquentes →
                </a>
            </div>
        </div>
    </section>

    <footer class="bg-card border-t border-border py-12">
        <div class="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-2xl font-bold">
                MOOV<span class="text-primary">.</span>
            </div>
            <div class="text-muted text-sm">
                &copy; 2024 Moov Location. Antony, France.
            </div>
            <div class="flex gap-6">
                <a href="#" class="text-muted hover:text-white"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-muted hover:text-white"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </footer>

    <div id="booking-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeBookingModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-card w-full max-w-4xl rounded-3xl border border-border shadow-2xl p-8 fade-in max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold" id="modal-vehicle-title">Réservation</h2>
                    <button onclick="closeBookingModal()" class="text-muted hover:text-white">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <div class="mb-8">
                            <img id="modal-vehicle-image" src="" alt="" class="w-full h-48 object-cover rounded-2xl mb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold" id="modal-vehicle-name"></h3>
                                    <p class="text-muted" id="modal-vehicle-details"></p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold" id="modal-vehicle-price"></div>
                                    <div class="text-sm text-muted">/jour estimé minimum</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-4">Choisissez vos dates</h3>
                            <div class="flex justify-between items-center mb-4">
                                <button onclick="changeMonth(-1)" class="text-muted hover:text-white">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <h4 class="text-lg font-bold" id="current-month">Mois 2024</h4>
                                <button onclick="changeMonth(1)" class="text-muted hover:text-white">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="calendar-grid mb-2">
                                <div class="text-center text-sm text-muted">Lun</div>
                                <div class="text-center text-sm text-muted">Mar</div>
                                <div class="text-center text-sm text-muted">Mer</div>
                                <div class="text-center text-sm text-muted">Jeu</div>
                                <div class="text-center text-sm text-muted">Ven</div>
                                <div class="text-center text-sm text-muted">Sam</div>
                                <div class="text-center text-sm text-muted">Dim</div>
                            </div>
                            <div id="calendar-days" class="calendar-grid"></div>
                        </div>

                        <div class="bg-input rounded-xl p-4 mb-6">
                            <div class="flex justify-between mb-2">
                                <span class="text-muted">Dates sélectionnées :</span>
                                <span class="font-bold" id="selected-dates-display">Aucune date</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-muted">Nombre de jours :</span>
                                <span class="font-bold" id="days-count">0</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-6">Vos informations</h3>

                        <div class="space-y-4 mb-8">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nom complet</label>
                                <input type="text" id="booking-name" class="w-full bg-input border border-border rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Votre nom">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="booking-email" class="w-full bg-input border border-border rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="votre@email.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Téléphone</label>
                                <input type="tel" id="booking-phone" class="w-full bg-input border border-border rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="06 12 34 56 78">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Notes (optionnel)</label>
                                <textarea id="booking-notes" class="w-full bg-input border border-border rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none" rows="3" placeholder="Informations supplémentaires..."></textarea>
                            </div>
                        </div>

                        <div class="bg-input rounded-xl p-6 mb-6">
                            <h4 class="font-bold mb-4">Récapitulatif</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-muted">Location</span>
                                    <span id="price-base">0€</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-muted">Caution</span>
                                    <span id="price-deposit">0€</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-muted">Ajustement période</span>
                                    <span id="price-demand-adjustment">0€</span>
                                </div>
                                <div class="border-t border-border pt-3">
                                    <div class="flex justify-between font-bold">
                                        <span>Total location à payer maintenant</span>
                                        <span id="price-total">0€</span>
                                    </div>
                                    <div class="text-sm text-muted mt-1">La caution sera pré-autorisée sur votre carte</div>
                                </div>
                            </div>
                        </div>

                        <button id="confirm-booking-btn" onclick="processBooking()" class="w-full bg-primary hover:bg-primaryHover text-white font-bold py-4 rounded-xl transition-all">
                            Payer et réserver
                        </button>
                        <p class="text-sm text-muted text-center mt-4">
                            En cliquant, vous acceptez nos conditions générales
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button onclick="openAdminLogin()" class="fixed bottom-6 right-6 z-50 w-10 h-10 bg-card border border-border rounded-full flex items-center justify-center text-muted hover:text-white hover:border-primary transition-all cursor-pointer" title="Accès administrateur">
        <i class="fas fa-cog text-sm"></i>
    </button>

    <div id="admin-login-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeAdminLogin()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-card w-full max-w-md rounded-3xl border border-border shadow-2xl p-8 fade-in">
                <h2 class="text-2xl font-bold mb-2">Accès Administrateur</h2>
                <p class="text-muted mb-6">Veuillez entrer le mot de passe pour accéder à l'espace d'administration.</p>
                <input type="password" id="admin-password-input" class="w-full bg-input border border-border rounded-lg px-4 py-3 mb-4 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Mot de passe">
                <button onclick="attemptAdminLogin()" class="w-full bg-primary hover:bg-primaryHover text-white font-bold py-3 rounded-xl transition-all cursor-pointer">
                    Se connecter
                </button>
                <p id="admin-login-error" class="text-red-500 text-sm mt-4 hidden">Mot de passe incorrect.</p>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-page">
            <div class="container mx-auto px-6 py-8 h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold">Administration Moov</h1>
                    <button onclick="closeAdminPanel()" class="text-muted hover:text-white">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="bg-card rounded-2xl border border-border p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Calendrier des réservations</h2>
                        <div class="flex gap-4">
                            <button onclick="adminChangeMonth(-1)" class="text-muted hover:text-white">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 class="text-lg font-bold" id="admin-current-month">Mois 2024</h3>
                            <button onclick="adminChangeMonth(1)" class="text-muted hover:text-white">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div id="admin-calendar" class="calendar-grid"></div>
                </div>

                <div class="bg-card rounded-2xl border border-border p-6">
                    <h2 class="text-xl font-bold mb-6">Réservations en cours</h2>
                    <div id="admin-reservations-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "";
        const ADMIN_SESSION_KEY = "moov_admin_session";
        const ADMIN_TOKEN_KEY = "moov_admin_token";
        const PRICING_ANALYTICS_KEY = "moov_pricing_analytics";
        const REQUIRE_BACKEND_PRICING_MATCH = true;

        // Règles de demande (similaire à PricingRules / SeasonRules backend)
        const DEMAND_PERIODS = [
            { name: "Vacances scolaires", start: "2026-02-14", end: "2026-03-02", category: "car", factor: 1.12 },
            { name: "Été utilitaires", start: "2026-07-01", end: "2026-08-31", category: "van", factor: 1.30 },
            { name: "Été voitures", start: "2026-07-01", end: "2026-08-31", category: "car", factor: 1.15 },
            { name: "Ponts de mai", start: "2026-05-01", end: "2026-05-11", category: "all", factor: 1.15 }
        ];

        const vehicles = {
            particuliers: [
                { id: 1, name: "Peugeot 208 GT Auto", category: "particuliers", image: "https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=800&h=600&fit=crop", baseWeekday: 48, baseWeekend: 58, minPrice: 42, maxPrice: 95, priceWeek: 48, priceWeekend: 58, kmExtra: 0.25, deposit: 1000, description: "Berline compacte sportive - Boîte automatique", seats: 5, luggage: 3, features: ["Climatisation", "GPS", "Caméra de recul", "Régulateur de vitesse"] },
                { id: 2, name: "Volkswagen Polo 6", category: "particuliers", image: "https://images.unsplash.com/photo-1549399542-7e3f8b79c341?w=800&h=600&fit=crop", baseWeekday: 45, baseWeekend: 55, minPrice: 39, maxPrice: 85, priceWeek: 45, priceWeekend: 55, kmExtra: 0.25, deposit: 800, description: "Citadine élégante - Finition United", seats: 5, luggage: 2, features: ["Climatisation", "Apple CarPlay", "Régulateur de vitesse", "Aide au stationnement"] },
                { id: 5, name: "Volkswagen Golf 8 Auto", category: "particuliers", image: "https://images.unsplash.com/photo-1617469767053-d3b523a0b982?w=800&h=600&fit=crop", baseWeekday: 57, baseWeekend: 67, minPrice: 49, maxPrice: 110, priceWeek: 57, priceWeekend: 67, kmExtra: 0.25, deposit: 1000, description: "Compacte premium - Boîte automatique", seats: 5, luggage: 3, features: ["Climatisation", "Apple CarPlay", "Régulateur adaptatif", "Caméra de recul"] }
            ],
            utilitaires: [
                { id: 3, name: "Citroën Jumpy", category: "utilitaires", image: "https://images.unsplash.com/photo-1549399542-7e3f8b79c341?w=800&h=600&fit=crop", baseWeekday: 55, baseWeekend: 68, minPrice: 50, maxPrice: 120, priceWeek: 55, priceWeekend: 68, kmExtra: 0.30, deposit: 1200, description: "Utilitaire 9m³ - Diesel", seats: 3, luggage: "9m³", features: ["Hayon arrière", "Régulateur", "Bluetooth", "Grand volume"] },
                { id: 4, name: "Opel Movano 12m³", category: "utilitaires", image: "https://images.unsplash.com/photo-1549399542-7e3f8b79c341?w=800&h=600&fit=crop", baseWeekday: 63, baseWeekend: 76, minPrice: 58, maxPrice: 135, priceWeek: 63, priceWeekend: 76, kmExtra: 0.30, deposit: 1500, description: "Grand utilitaire 12m³ - Diesel", seats: 3, luggage: "12m³", features: ["Hayon élévateur", "Caméra de recul", "Climatisation", "Grande autonomie"] }
            ]
        };

        let bookings = [];
        let currentVehicle = null;
        let selectedDates = { start: null, end: null };
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let adminCurrentMonth = new Date().getMonth();
        let adminCurrentYear = new Date().getFullYear();

        function pad2(n) { return String(n).padStart(2, '0'); }
        function toLocalISO(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
        function todayISO() {
            const now = new Date();
            return toLocalISO(new Date(now.getFullYear(), now.getMonth(), now.getDate()));
        }
        function getVehicleType(vehicle) {
            return vehicle.category === 'utilitaires' ? 'van' : 'car';
        }

        function getVehicleBaseWeekday(vehicle) {
            return Number(vehicle.baseWeekday ?? vehicle.priceWeek ?? 0);
        }

        function getVehicleBaseWeekend(vehicle) {
            return Number(vehicle.baseWeekend ?? vehicle.priceWeekend ?? getVehicleBaseWeekday(vehicle));
        }

        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function getPriceBucket(price) {
            const step = 5;
            const min = Math.floor(price / step) * step;
            const max = min + step - 1;
            return `${min}-${max}`;
        }

        function pushPricingAnalytics(event) {
            const payload = {
                ...event,
                at: new Date().toISOString()
            };

            try {
                const current = JSON.parse(localStorage.getItem(PRICING_ANALYTICS_KEY) || '[]');
                current.push(payload);
                localStorage.setItem(PRICING_ANALYTICS_KEY, JSON.stringify(current.slice(-1000)));
            } catch (e) {
                console.warn('Impossible de stocker les analytics de prix en local.', e);
            }

            fetch(`${API_BASE}/api/pricing-metrics`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(() => {
                // silencieux: le localStorage garde une trace en fallback
            });
        }

        function trackVehicleExposure(vehicle) {
            const displayedMin = getVehicleDisplayMinPrice(vehicle);
            pushPricingAnalytics({
                type: 'vehicle_exposure',
                vehicleId: vehicle.id,
                category: vehicle.category,
                displayedMinPrice: displayedMin,
                priceBucket: getPriceBucket(displayedMin)
            });
        }

        function trackVehicleCardClick(vehicle) {
            const displayedMin = getVehicleDisplayMinPrice(vehicle);
            pushPricingAnalytics({
                type: 'vehicle_click',
                vehicleId: vehicle.id,
                category: vehicle.category,
                displayedMinPrice: displayedMin,
                priceBucket: getPriceBucket(displayedMin)
            });
        }

        function getVehicleDisplayMinPrice(vehicle) {
            const vehicleType = getVehicleType(vehicle);
            const seasonFactors = DEMAND_PERIODS
                .filter(rule => rule.category === 'all' || rule.category === vehicleType)
                .map(rule => Number(rule.factor));
            const seasonalMin = Math.min(1, ...(seasonFactors.length ? seasonFactors : [1]));

            const occupancyMin = 0.90;
            const lastMinuteMin = 0.90;
            const theoretical = getVehicleBaseWeekday(vehicle) * seasonalMin * occupancyMin * lastMinuteMin;
            const clamped = clamp(theoretical, Number(vehicle.minPrice ?? 0), Number(vehicle.maxPrice ?? theoretical));
            return Math.round(clamped);
        }


        async function loadBookingsPublic(months = 6) {
            try {
                const res = await fetch(`${API_BASE}/api/bookings-public?months=${months}`);
                if (!res.ok) return;
                const data = await res.json();
                bookings = Array.isArray(data.bookings) ? data.bookings : [];
                if (currentVehicle) updateCalendar();
            } catch (e) {
                console.warn("Impossible de charger les disponibilités (backend).", e);
            }
        }

        function navigateToHome() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function navigateToFAQ() {
            scrollToSection('faq');
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) element.scrollIntoView({ behavior: 'smooth' });
        }

        function switchCategory(category) {
            document.getElementById('tab-particuliers').classList.toggle('active', category === 'particuliers');
            document.getElementById('tab-utilitaires').classList.toggle('active', category === 'utilitaires');
            loadVehicles(category);
        }

        function loadVehicles(category) {
            const grid = document.getElementById('vehicle-grid');
            grid.innerHTML = '';

            vehicles[category].forEach(vehicle => {
                trackVehicleExposure(vehicle);
                grid.innerHTML += `
                    <div class="bg-card border border-border rounded-2xl p-6 hover:border-primary/50 transition-all cursor-pointer" onclick="trackVehicleCardClick(vehicles['${category}'].find(v => v.id === ${vehicle.id})); openBookingModal(${vehicle.id})">
                        <img src="${vehicle.image}" alt="${vehicle.name}" class="w-full h-48 object-cover rounded-xl mb-4">
                        <h3 class="text-xl font-bold mb-2">${vehicle.name}</h3>
                        <p class="text-muted mb-4">${vehicle.description}</p>
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-2xl font-bold">${getVehicleDisplayMinPrice(vehicle)}€</div>
                                <div class="text-sm text-muted">/jour estimé minimum</div>
                            </div>
                            <div class="text-primary"><i class="fas fa-arrow-right"></i></div>
                        </div>
                    </div>
                `;
            });
        }

        function openBookingModal(vehicleId) {
            let vehicle = null;
            for (const category in vehicles) {
                vehicle = vehicles[category].find(v => v.id === vehicleId);
                if (vehicle) break;
            }
            if (!vehicle) return;

            currentVehicle = vehicle;
            selectedDates = { start: null, end: null };

            document.getElementById('modal-vehicle-title').textContent = `Réservation - ${vehicle.name}`;
            document.getElementById('modal-vehicle-image').src = vehicle.image;
            document.getElementById('modal-vehicle-image').alt = vehicle.name;
            document.getElementById('modal-vehicle-name').textContent = vehicle.name;
            document.getElementById('modal-vehicle-details').textContent = vehicle.description;
            document.getElementById('modal-vehicle-price').textContent = `${getVehicleDisplayMinPrice(vehicle)}€`;

            document.getElementById('booking-name').value = '';
            document.getElementById('booking-email').value = '';
            document.getElementById('booking-phone').value = '';
            document.getElementById('booking-notes').value = '';

            updateCalendar();
            updateSelectedDatesDisplay();
            updatePriceSummary();

            document.getElementById('booking-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeBookingModal() {
            document.getElementById('booking-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function updateCalendar() {
            const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            let calendarHTML = '';
            for (let i = 0; i < startingDay; i++) {
                calendarHTML += '<div class="cal-day disabled"></div>';
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = toLocalISO(date);
                const isPast = dateStr < todayISO();
                const isBooked = isDateBooked(dateStr, currentVehicle?.id);
                const isSelected = selectedDates.start === dateStr || selectedDates.end === dateStr;
                const isInRange = selectedDates.start && selectedDates.end &&
                    date >= new Date(selectedDates.start) &&
                    date <= new Date(selectedDates.end);

                let dayClass = 'cal-day';
                if (isBooked || isPast) dayClass += ' disabled';
                if (isSelected) dayClass += ' selected';
                if (isInRange && !isSelected) dayClass += ' in-range';

                calendarHTML += `<div class="${dayClass}" onclick="${(!isBooked && !isPast) ? `selectDate('${dateStr}')` : ''}">${day}</div>`;
            }

            document.getElementById('calendar-days').innerHTML = calendarHTML;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function selectDate(dateStr) {
            if (dateStr < todayISO()) return;

            if (!selectedDates.start || (selectedDates.start && selectedDates.end)) {
                selectedDates = { start: dateStr, end: null };
            } else if (selectedDates.start && !selectedDates.end) {
                if (dateStr < selectedDates.start) {
                    selectedDates = { start: dateStr, end: selectedDates.start };
                } else {
                    selectedDates.end = dateStr;
                }

                if (selectedDates.start && selectedDates.end) {
                    let currentDate = new Date(selectedDates.start);
                    const endDate = new Date(selectedDates.end);

                    while (currentDate <= endDate) {
                        const checkDate = toLocalISO(currentDate);
                        if (isDateBooked(checkDate, currentVehicle?.id)) {
                            alert("Certaines dates dans cette plage sont déjà réservées.");
                            selectedDates = { start: null, end: null };
                            break;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            }

            updateCalendar();
            updateSelectedDatesDisplay();
            updatePriceSummary();
        }

        function isDateBooked(dateStr, vehicleId) {
            return bookings.some(booking => booking.vehicleId === vehicleId && dateStr >= booking.startDate && dateStr <= booking.endDate);
        }

        function updateSelectedDatesDisplay() {
            const display = document.getElementById('selected-dates-display');
            const daysCount = document.getElementById('days-count');

            if (selectedDates.start && selectedDates.end) {
                const start = new Date(selectedDates.start);
                const end = new Date(selectedDates.end);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                display.textContent = `${formatDate(start)} - ${formatDate(end)}`;
                daysCount.textContent = days;
            } else if (selectedDates.start) {
                display.textContent = formatDate(new Date(selectedDates.start));
                daysCount.textContent = '1';
            } else {
                display.textContent = 'Aucune date';
                daysCount.textContent = '0';
            }
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function getSeasonalFactor(date, vehicle) {
            const dayIso = toLocalISO(date);
            const vehicleType = getVehicleType(vehicle);
            const matchingRules = DEMAND_PERIODS.filter(rule => {
                const categoryMatch = rule.category === 'all' || rule.category === vehicleType;
                return categoryMatch && dayIso >= rule.start && dayIso <= rule.end;
            });
            return matchingRules.reduce((acc, r) => acc * r.factor, 1);
        }

        function getBridgeAndEndMonthFactor(date, vehicle) {
            const day = date.getDate();
            const isLongWeekendWindow = [1, 2, 3, 4, 8, 9, 10, 11].includes(day) && date.getMonth() === 4; // mai
            const isEndMonthMoveWindow = (day >= 27 || day <= 3) && getVehicleType(vehicle) === 'van';

            let factor = 1;
            if (isLongWeekendWindow) factor *= 1.12;
            if (isEndMonthMoveWindow) factor *= 1.15;
            return factor;
        }

        function getRolling30OccupancyFactor(vehicle) {
            const start = new Date();
            start.setHours(0, 0, 0, 0);
            const end = new Date(start);
            end.setDate(end.getDate() + 29);

            const bookedDays = new Set();
            bookings.forEach(booking => {
                if (booking.vehicleId !== vehicle.id) return;
                const bStart = new Date(booking.startDate);
                const bEnd = new Date(booking.endDate);
                const from = bStart > start ? bStart : new Date(start);
                const to = bEnd < end ? bEnd : new Date(end);
                const cursor = new Date(from);
                while (cursor <= to) {
                    bookedDays.add(toLocalISO(cursor));
                    cursor.setDate(cursor.getDate() + 1);
                }
            });

            const ratio = bookedDays.size / 30;
            if (ratio < 0.25) return 0.90;
            if (ratio <= 0.50) return 1;
            if (ratio <= 0.70) return 1.10;
            return 1.20;
        }

        function getLastMinuteFactor(date) {
            const now = new Date();
            const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const target = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const diffHours = (target - startDay) / (1000 * 60 * 60);
            return diffHours <= 48 ? 0.90 : 1;
        }

        function buildPricingEstimate(start, end, vehicle) {
            let basePrice = 0;
            let adjustedPrice = 0;
            let cursor = new Date(start);
            const occupancyFactor = getRolling30OccupancyFactor(vehicle);
            const dailyBreakdown = [];

            while (cursor <= end) {
                const dayOfWeek = cursor.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const baseDay = isWeekend ? getVehicleBaseWeekend(vehicle) : getVehicleBaseWeekday(vehicle);

                const raw = baseDay
                    * getSeasonalFactor(cursor, vehicle)
                    * getBridgeAndEndMonthFactor(cursor, vehicle)
                    * occupancyFactor
                    * getLastMinuteFactor(cursor);

                const seasonalFactor = getSeasonalFactor(cursor, vehicle);
                const bridgeFactor = getBridgeAndEndMonthFactor(cursor, vehicle);
                const lastMinuteFactor = getLastMinuteFactor(cursor);

                const clamped = clamp(raw, Number(vehicle.minPrice ?? baseDay), Number(vehicle.maxPrice ?? baseDay));
                basePrice += baseDay;
                adjustedPrice += clamped;
                dailyBreakdown.push({
                    date: toLocalISO(cursor),
                    baseDay,
                    seasonalFactor,
                    bridgeFactor,
                    occupancyFactor,
                    lastMinuteFactor,
                    raw: Math.round(raw * 100) / 100,
                    clamped: Math.round(clamped)
                });
                cursor.setDate(cursor.getDate() + 1);
            }

            const finalPrice = Math.round(adjustedPrice);
            return {
                basePrice: Math.round(basePrice),
                finalPrice,
                demandAdjustment: finalPrice - Math.round(basePrice),
                occupancyFactor,
                dailyBreakdown
            };
        }

        function isPricingConsistent(clientEstimate, serverEstimate) {
            if (!clientEstimate || !serverEstimate) return false;
            if (Math.round(clientEstimate.finalPrice) !== Math.round(serverEstimate.finalPrice)) return false;
            if (Math.round(clientEstimate.basePrice) !== Math.round(serverEstimate.basePrice)) return false;

            const clientDays = Array.isArray(clientEstimate.dailyBreakdown) ? clientEstimate.dailyBreakdown : [];
            const serverDays = Array.isArray(serverEstimate.dailyBreakdown) ? serverEstimate.dailyBreakdown : [];
            if (clientDays.length !== serverDays.length) return false;

            for (let i = 0; i < clientDays.length; i++) {
                if (clientDays[i].date !== serverDays[i].date) return false;
                if (Math.round(clientDays[i].clamped) !== Math.round(serverDays[i].clamped)) return false;
            }

            return true;
        }

        function updatePriceSummary() {
            if (!selectedDates.start || !selectedDates.end || !currentVehicle) {
                document.getElementById('price-base').textContent = '0€';
                document.getElementById('price-deposit').textContent = currentVehicle ? `${currentVehicle.deposit}€` : '0€';
                document.getElementById('price-demand-adjustment').textContent = '0€';
                document.getElementById('price-total').textContent = '0€';
                return;
            }

            const start = new Date(selectedDates.start);
            const end = new Date(selectedDates.end);
            const estimate = buildPricingEstimate(start, end, currentVehicle);
            const demandLabel = `${estimate.demandAdjustment >= 0 ? '+' : ''}${estimate.demandAdjustment}€`;

            document.getElementById('price-base').textContent = `${estimate.basePrice}€`;
            document.getElementById('price-deposit').textContent = `${currentVehicle.deposit}€`;
            document.getElementById('price-demand-adjustment').textContent = demandLabel;
            document.getElementById('price-total').textContent = `${estimate.finalPrice}€`;
        }

        async function processBooking() {
            const btn = document.getElementById('confirm-booking-btn');
            const name = document.getElementById('booking-name').value?.trim();
            const email = document.getElementById('booking-email').value?.trim();
            const phone = document.getElementById('booking-phone').value?.trim();
            const notes = document.getElementById('booking-notes').value?.trim();

            if (!name || !email || !phone) {
                alert("Veuillez remplir tous les champs obligatoires.");
                return;
            }
            if (!selectedDates.start || !selectedDates.end) {
                alert("Veuillez sélectionner des dates de location.");
                return;
            }
            if (selectedDates.start < todayISO()) {
                alert("Veuillez sélectionner des dates à partir d'aujourd'hui.");
                return;
            }
            if (!currentVehicle) {
                alert("Veuillez sélectionner un véhicule.");
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.dataset.prevText = btn.textContent;
                btn.textContent = "Redirection vers le paiement...";
            }

            try {
                const estimate = buildPricingEstimate(new Date(selectedDates.start), new Date(selectedDates.end), currentVehicle);
                pushPricingAnalytics({
                    type: 'checkout_attempt',
                    vehicleId: currentVehicle.id,
                    displayedMinPrice: getVehicleDisplayMinPrice(currentVehicle),
                    estimatedTotal: estimate.finalPrice,
                    priceBucket: getPriceBucket(getVehicleDisplayMinPrice(currentVehicle))
                });
                const payload = {
                    vehicleId: currentVehicle.id,
                    startDate: selectedDates.start,
                    endDate: selectedDates.end,
                    customer: { name, email, phone },
                    notes: notes || "",
                    pricingEstimate: estimate
                };

                const res = await fetch(`${API_BASE}/api/checkout`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    alert(data?.error || "Impossible de créer la session de paiement.");
                    return;
                }
                if (!data?.url) {
                    alert("Réponse Stripe invalide (URL manquante).");
                    return;
                }

                if (REQUIRE_BACKEND_PRICING_MATCH) {
                    if (!data?.pricingEstimateServer) {
                        alert("Validation prix manquante côté serveur. Paiement bloqué par sécurité.");
                        return;
                    }
                    if (!isPricingConsistent(estimate, data.pricingEstimateServer)) {
                        alert("Le prix recalculé côté serveur diffère de l'estimation. Merci de relancer la réservation.");
                        return;
                    }
                }

                pushPricingAnalytics({
                    type: 'checkout_redirect',
                    vehicleId: currentVehicle.id,
                    estimatedTotal: estimate.finalPrice,
                    priceBucket: getPriceBucket(getVehicleDisplayMinPrice(currentVehicle))
                });

                window.location.href = data.url;
            } catch (e) {
                console.error(e);
                alert("Erreur réseau. Réessayez.");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = btn.dataset.prevText || "Payer et réserver";
                }
            }
        }

        function toggleFAQ(number) {
            const answer = document.getElementById(`faq-answer-${number}`);
            const icon = document.getElementById(`faq-icon-${number}`);
            answer.classList.toggle('open');
            icon.classList.toggle('rotate-180');
        }

        function openAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('hidden');
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-login-error').classList.add('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAdminLogin() {
            document.getElementById('admin-login-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        async function attemptAdminLogin() {
            const input = document.getElementById('admin-password-input').value;
            try {
                const res = await fetch(`${API_BASE}/api/admin/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password: input })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data?.error || "Mot de passe incorrect.");
                localStorage.setItem(ADMIN_SESSION_KEY, 'true');
                localStorage.setItem(ADMIN_TOKEN_KEY, data.token);
                closeAdminLogin();
                openAdminPanel();
            } catch (e) {
                document.getElementById('admin-login-error').classList.remove('hidden');
            }
        }

        function openAdminPanel() {
            updateAdminCalendar();
            loadAdminReservations();
            document.getElementById('admin-panel').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAdminPanel() {
            document.getElementById('admin-panel').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function adminChangeMonth(delta) {
            adminCurrentMonth += delta;
            if (adminCurrentMonth < 0) {
                adminCurrentMonth = 11;
                adminCurrentYear--;
            } else if (adminCurrentMonth > 11) {
                adminCurrentMonth = 0;
                adminCurrentYear++;
            }
            updateAdminCalendar();
        }

        function updateAdminCalendar() {
            const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            document.getElementById('admin-current-month').textContent = `${monthNames[adminCurrentMonth]} ${adminCurrentYear}`;

            const firstDay = new Date(adminCurrentYear, adminCurrentMonth, 1);
            const lastDay = new Date(adminCurrentYear, adminCurrentMonth + 1, 0);
            const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            let calendarHTML = '';
            for (let i = 0; i < startingDay; i++) {
                calendarHTML += '<div class="cal-day disabled"></div>';
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(adminCurrentYear, adminCurrentMonth, day);
                const dateStr = toLocalISO(date);
                const dayBookings = getBookingsForDate(dateStr);

                let dayClass = 'cal-day';
                let dayContent = day;
                if (dayBookings.length > 0) {
                    dayClass += ' bg-red-500/20 text-red-300';
                    dayContent = `<span class="relative">${day}<span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span></span>`;
                }

                calendarHTML += `<div class="${dayClass}" onclick="showDateBookings('${dateStr}')">${dayContent}</div>`;
            }

            document.getElementById('admin-calendar').innerHTML = calendarHTML;
        }

        function getBookingsForDate(dateStr) {
            return bookings.filter(booking => {
                const date = new Date(dateStr);
                const start = new Date(booking.startDate);
                const end = new Date(booking.endDate);
                return date >= start && date <= end;
            });
        }

        function showDateBookings(dateStr) {
            const dateBookings = getBookingsForDate(dateStr);
            if (dateBookings.length > 0) {
                alert(`Réservations pour le ${formatDate(new Date(dateStr))}:\n\n` +
                      dateBookings.map(b => `• ${b.vehicleName || b.vehicleId} - ${b.customerName || 'Client'}`).join('\n'));
            }
        }

        async function loadAdminReservations() {
            const list = document.getElementById('admin-reservations-list');
            const token = localStorage.getItem(ADMIN_TOKEN_KEY);
            if (!token) {
                list.innerHTML = '<div class="text-muted">Connectez-vous.</div>';
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/api/admin/bookings`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data?.error || "Erreur chargement.");
                const items = Array.isArray(data.bookings) ? data.bookings : [];
                if (!items.length) {
                    list.innerHTML = '<div class="text-muted">Aucune réservation.</div>';
                    return;
                }
                list.innerHTML = items.map(b => `
                    <div class="border border-border rounded-xl p-4 mb-3 bg-card">
                        <div class="flex items-center justify-between">
                            <div class="font-bold">${b.vehicleName}</div>
                            <div class="text-sm ${b.status === 'CONFIRMED' ? 'text-green-400' : 'text-yellow-400'}">${b.status}</div>
                        </div>
                        <div class="text-sm text-muted mt-2">${b.startDate} → ${b.endDate} · ${b.totalPaidEUR}€</div>
                        <div class="text-sm text-muted mt-1">Client: ${b.customerName} — ${b.customerEmail} — ${b.customerPhone}</div>
                        ${b.notes ? `<div class="text-sm text-muted mt-1">Notes: ${b.notes}</div>` : ''}
                        <div class="text-xs text-muted mt-2">BookingId: ${b.bookingId}</div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<div class="text-muted">Impossible de charger les réservations.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchCategory('particuliers');
            loadBookingsPublic(6);
        });
    </script>
</body>
</html>
